import React, { useState, useRef, useEffect } from "react";
import { Formik, Form, Field } from "formik";
import {
  Card,
  Input,
  Button,
  Select,
  Divider,
  Skeleton,
  Alert,
  Typography,
  message,
  Descriptions,
} from "antd";
import * as Yup from "yup";
import { LoadingOutlined, QrcodeOutlined } from "@ant-design/icons";
import { Html5Qrcode } from "html5-qrcode";
import { coreAxios } from "../../utilities/axios";

const { Title, Text } = Typography;
const { Option } = Select;

const ScholarshipPayment = () => {
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [scholarshipDetails, setScholarshipDetails] = useState(null);
  const [scanning, setScanning] = useState(false);
  const [cameraError, setCameraError] = useState(false);
  const [pendingRequests, setPendingRequests] = useState([]);
  const scannerRef = useRef(null);
  const scannerId = "qr-reader";

  useEffect(() => {
    if (!scanning) return;

    const html5QrCode = new Html5Qrcode(scannerId);
    scannerRef.current = html5QrCode;

    const startScanner = async () => {
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras && cameras.length) {
          const backCamera = cameras.find((camera) =>
            camera.label.toLowerCase().includes("back")
          );
          const cameraId = backCamera ? backCamera.id : cameras[0].id;

          await html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
            },
            (decodedText) => {
              handleScanSuccess(decodedText);
            },
            (errorMessage) => {
              // ignore scan errors
            }
          );
        } else {
          setCameraError(true);
          message.error(
            "ржХрзЛржи ржХрзНржпрж╛ржорзЗрж░рж╛ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзБржиред"
          );
        }
      } catch (err) {
        console.error("Camera error:", err);
        setCameraError(true);
        message.error(
          "ржХрзНржпрж╛ржорзЗрж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред ржЕржирзБржорждрж┐ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзБржиред"
        );
      }
    };

    const handleScanSuccess = async (decodedText) => {
      try {
        // Validate scanned ID format
        // if (!/^DMS\d{5}$/.test(decodedText)) {
        //   message.error("ржЕржмрзИржз рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржЖржЗржбрж┐ ржлрж░ржорзНржпрж╛ржЯ");
        //   setScanning(false);
        //   return;
        // }

        // Stop scanner
        await scannerRef.current.stop();
        setScanning(false);

        // Process the scanned ID
        const details = await fetchScholarshipDetails(decodedText);
        if (details) {
          setScholarshipDetails(details);
          setPendingRequests(details.pendingRequests);
          setStep(2);
          message.success("рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржЖржЗржбрж┐ рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ!");
        }
      } catch (err) {
        console.error("Error handling scan:", err);
        message.error("рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржЖржЗржбрж┐ ржпрж╛ржЪрж╛ржЗ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗ");
        setScanning(false);
      }
    };

    startScanner();

    return () => {
      if (scannerRef.current && scannerRef.current.isScanning) {
        scannerRef.current.stop().catch(() => {});
      }
    };
  }, [scanning]);

  const fetchPendingRequests = async (scholarshipID) => {
    try {
      const response = await coreAxios.get(
        `/scholarship-cost-info/${scholarshipID}`
      );
      return response.data || [];
    } catch (error) {
      console.error("Error fetching pending requests:", error);
      return [];
    }
  };

  const determineScholarshipDetails = (studentData) => {
    const classNumber = parseInt(studentData.instituteClass);
    const totalMarks = studentData.resultDetails[0]?.totalMarks || 0;
    let grade = null;
    let withdrawalBalance = 0;
    let registrationBalance = 0;

    // For classes 3 to 5
    if (classNumber >= 3 && classNumber <= 5) {
      if (totalMarks >= 45 && totalMarks <= 48) {
        grade = "General Grade";
        withdrawalBalance = 700;
        registrationBalance = 3000;
      } else if (totalMarks >= 49 && totalMarks <= 50) {
        grade = "Talentpool Grade";
        withdrawalBalance = 1000;
        registrationBalance = 3500;
      }
    }
    // For classes 6 to 10
    else if (classNumber >= 6 && classNumber <= 10) {
      if (totalMarks >= 75 && totalMarks < 80) {
        grade = "General Grade";
        withdrawalBalance = 1000;
        registrationBalance = 3500;
      } else if (totalMarks >= 80 && totalMarks <= 100) {
        grade = "Talentpool Grade";
        withdrawalBalance = 1500;
        registrationBalance = 4000;
      }
    }

    return {
      scholarshipID: studentData.scholarshipRollNumber,
      studentName: studentData.name,
      program: studentData.institute,
      class: studentData.instituteClass,
      totalMarks,
      grade,
      withdrawalBalance,
      registrationBalance,
      eligible: grade !== null,
      image: studentData.image,
    };
  };

  const fetchScholarshipDetails = async (scholarshipID) => {
    setLoading(true);
    try {
      const [studentResponse, pendingRequests] = await Promise.all([
        coreAxios.get(`/search-result/${scholarshipID}`),
        fetchPendingRequests(scholarshipID),
      ]);

      const studentData = studentResponse.data;
      const details = determineScholarshipDetails(studentData);

      if (!details.eligible) {
        message.error("ржПржЗ рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржкрж╛ржпрж╝ржирж┐ред");
        return null;
      }

      // Calculate available balance by subtracting pending requests
      const totalPending = pendingRequests.reduce(
        (sum, req) => sum + req.amount,
        0
      );

      const availableBalance = Math.max(
        0,
        details.withdrawalBalance - totalPending
      );

      return {
        ...details,
        availableBalance,
        pendingRequests,
        originalWithdrawalBalance: details.withdrawalBalance,
      };
    } catch (error) {
      console.error("Error fetching scholarship details:", error);
      message.error("рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк рждржерзНржп ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржЖржЗржбрж┐ ржЪрзЗржХ ржХрж░рзБржиред");
      return null;
    } finally {
      setLoading(false);
    }
  };

  const handleScholarshipIDSubmit = async (values) => {
    try {
      const details = await fetchScholarshipDetails(values.scholarshipID);
      if (details) {
        setScholarshipDetails(details);
        setPendingRequests(details.pendingRequests);
        setStep(2);
      }
    } catch (error) {
      console.error("Error processing scholarship details:", error);
    }
  };

  const handleWithdrawalSubmit = async (values, { setSubmitting }) => {
    setLoading(true);

    const currentBalance = scholarshipDetails.availableBalance;

    // Validation: Check if amount exceeds current balance
    if (values.amount > currentBalance) {
      message.warning(
        "ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржкрж░рж┐ржорж╛ржг ржмрж░рзНрждржорж╛ржи ржмрзНржпрж╛рж▓рзЗржирзНрж╕рзЗрж░ ржЪрзЗржпрж╝рзЗ ржмрзЗрж╢рж┐ рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛!"
      );
      setLoading(false);
      setSubmitting(false);
      return;
    }

    try {
      const response = await coreAxios.post("/cost-info-2", {
        scholarshipID: scholarshipDetails.scholarshipID,
        amount: values.amount,
        paymentMethod: values.paymentMethod,
        fundName: "withdrawal",
        currentBalance: currentBalance - values.amount,
        description: "Scholarship fund withdrawal",
        status: "pending",
      });

      // Changed this check to match backend response
      if (
        response.data.message ===
        "Cost and scholarship cost info submitted successfully"
      ) {
        message.success("ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕржирзБрж░рзЛржз рж╕ржлрж▓ржнрж╛ржмрзЗ ржЬржорж╛ рж╣ржпрж╝рзЗржЫрзЗ!");
        setStep(3);
      } else {
        throw new Error(response.data.message || "API request failed");
      }
    } catch (error) {
      console.error("Error submitting withdrawal:", error);
      message.error(
        error.response?.data?.message ||
          "ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕржирзБрж░рзЛржз ржЬржорж╛ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред ржкрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред"
      );
    } finally {
      setLoading(false);
      setSubmitting(false);
    }
  };

  const resetForm = () => {
    setScholarshipDetails(null);
    setPendingRequests([]);
    setStep(1);
  };

  const startQRScanner = () => {
    setScanning(true);
  };

  return (
    <div className="min-h-screen bg-green-50 py-8 px-4 pt-20">
      <div className="max-w-4xl mx-auto">
        <Card className="shadow-lg border-green-200">
          <Title level={3} className="text-center mb-6 text-green-800">
            рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржлрж╛ржирзНржб ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛
          </Title>

          <Alert
            message="ЁЯУМ рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржлрж╛ржирзНржб ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирж┐рж░рзНржжрзЗрж╢ржирж╛"
            description={
              <div className="text-green-700">
                <p className="mb-2">
                  рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржлрж╛ржирзНржб ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЖржЧрзЗ ржирж┐ржЪрзЗрж░ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ржЧрзБрж▓рзЛ ржЕржирзБрж╕рж░ржг ржХрж░рзБржи:
                </p>
                <ul className="pl-5 space-y-1">
                  <li>
                    <span className="font-bold">*</span> ржЙржЗржержбрзНрж░рзЛ ржХрж░рж╛ ржЕрж░рзНрже
                    рж╢рзБржзрзБржорж╛рждрзНрж░ ржмрзНржпржХрзНрждрж┐ржЧржд ржЦрж░ржЪрзЗрж░ ржЬржирзНржп ржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржпред
                  </li>
                  <li>
                    <span className="font-bold">*</span> рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржмрзНржпрж╛рж▓рзЗржирзНрж╕
                    рж╢рзБржзрзБржорж╛рждрзНрж░ ржХрзЛрж░рзНрж╕ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржирзЗрж░ ржЬржирзНржпред
                  </li>
                  <li>
                    <span className="font-bold">*</span> ржЙржЗржержбрзНрж░рзЛ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ
                    ржкрзНрж░рж╕рзЗрж╕ рж╣рждрзЗ рзй-рзл ржХрж░рзНржоржжрж┐ржмрж╕ рж╕ржорзЯ рж▓рж╛ржЧрждрзЗ ржкрж╛рж░рзЗред
                  </li>
                  <li>
                    <span className="font-bold">*</span> рж╕рж╛ржмржорж┐ржЯ ржХрж░рж╛рж░ ржЖржЧрзЗ рж╕ржХрж▓
                    рждржерзНржп ржнрж╛рж▓рзЛржнрж╛ржмрзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рзЗ ржирж┐ржиред
                  </li>
                </ul>
              </div>
            }
            type="success"
            showIcon
            className="mb-6 border-green-300 bg-green-50"
          />

          {scanning && (
            <div className="mb-6">
              <p className="text-center font-semibold text-green-700 mb-2">
                рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржХрж┐ржЙржЖрж░ ржХрзЛржб рж╕рзНржХрзНржпрж╛ржи ржХрж░рзБржи
              </p>
              {cameraError ? (
                <div className="text-center p-4 border rounded bg-gray-50">
                  <p className="text-red-500 mb-2">
                    ржХрзНржпрж╛ржорзЗрж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗ
                  </p>
                  <Button
                    type="primary"
                    onClick={() => {
                      setCameraError(false);
                      setScanning(true);
                    }}
                  >
                    ржХрзНржпрж╛ржорзЗрж░рж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржкрзБржирж░рж╛ржпрж╝ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи
                  </Button>
                </div>
              ) : (
                <div className="w-full h-[250px] border rounded bg-gray-50 flex items-center justify-center">
                  <div id={scannerId} className="w-full h-full" />
                </div>
              )}
              <div className="text-center mt-4">
                <Button onClick={() => setScanning(false)}>
                  рж╕рзНржХрзНржпрж╛ржи ржмрж╛рждрж┐рж▓ ржХрж░рзБржи
                </Button>
              </div>
            </div>
          )}

          {!scanning && step === 1 && (
            <Formik
              initialValues={{ scholarshipID: "" }}
              onSubmit={handleScholarshipIDSubmit}
            >
              {({ errors, touched, setFieldValue }) => (
                <Form>
                  <div className="mb-6">
                    <label
                      htmlFor="scholarshipID"
                      className="block text-sm font-medium text-green-700 mb-2"
                    >
                      рж╕рзНржХрж▓рж╛рж░рж╢рж┐ржк ржЖржЗржбрж┐ рж▓рж┐ржЦрзБржи
                    </label>
                    <div className="flex gap-2">
                      <Field
                        as={Input}
                        name="scholarshipID"
                        placeholder="ржпрзЗржоржи: DMS25000"
                        size="large"
                        className={`flex-1 ${
                          errors.scholarshipID && touched.scholarshipID
                            ? "border-red-500"
                            : "border-green-300"
                        }`}
                      />
                      <Button
                        type="default"
                        size="large"
                        icon={<QrcodeOutlined />}
                        onClick={startQRScanner}
                        className="border-green-300"
                      >
                        рж╕рзНржХрзНржпрж╛ржи ржХрж░рзБржи
                      </Button>
                    </div>
                    {errors.scholarshipID && touched.scholarshipID ? (
                      <div className="text-red-500 text-sm mt-1">
                        {errors.scholarshipID}
                      </div>
                    ) : null}
                  </div>

                  <Button
                    type="primary"
                    htmlType="submit"
                    size="large"
                    className="w-full bg-green-600 hover:bg-green-700 border-green-700"
                    loading={loading}
                  >
                    {loading ? "ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." : "ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржЪрзЗржХ ржХрж░рзБржи"}
                  </Button>
                </Form>
              )}
            </Formik>
          )}

          {!scanning && step === 2 && scholarshipDetails && (
            <div>
              {loading ? (
                <Skeleton active paragraph={{ rows: 4 }} />
              ) : (
                <>
                  <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                    <div className="flex items-center mb-4">
                      {scholarshipDetails.image && (
                        <img
                          src={scholarshipDetails.image}
                          alt="Student"
                          className="w-16 h-16 rounded-full object-cover mr-4"
                        />
                      )}
                      <div>
                        <Title level={4} className="mb-0 text-green-800">
                          {scholarshipDetails.studentName}
                        </Title>
                        <Text className="text-green-600">
                          {scholarshipDetails.program}
                        </Text>
                      </div>
                    </div>

                    <Descriptions
                      bordered
                      column={2}
                      size="small"
                      className="mb-4"
                    >
                      <Descriptions.Item label="рж╢рзНрж░рзЗржгрзА">
                        {scholarshipDetails.class}
                      </Descriptions.Item>
                      <Descriptions.Item label="ржкрзНрж░рж╛ржкрзНржд ржиржорзНржмрж░">
                        {scholarshipDetails.totalMarks}
                      </Descriptions.Item>
                      <Descriptions.Item label="ржЧрзНрж░рзЗржб">
                        <span className="font-semibold">
                          {scholarshipDetails.grade}
                        </span>
                      </Descriptions.Item>
                      <Descriptions.Item label="ржЖржЗржбрж┐">
                        {scholarshipDetails.scholarshipID}
                      </Descriptions.Item>
                    </Descriptions>

                    {/* Pending Requests */}
                    {pendingRequests.filter((req) => req.status !== "approved")
                      .length > 0 && (
                      <Alert
                        message="ржорзБрж▓рждрзБржмрж┐ ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕржирзБрж░рзЛржз"
                        description={
                          <div>
                            <p>ржЖржкржирж╛рж░ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржорзБрж▓рждрзБржмрж┐ ржЕржирзБрж░рзЛржз ржЖржЫрзЗ:</p>
                            <ul className="list-disc pl-5">
                              {pendingRequests
                                .filter((req) => req.status !== "approved")
                                .map((req, index) => (
                                  <li key={index}>
                                    {req.amount} ржЯрж╛ржХрж╛ ({req.paymentMethod}) -{" "}
                                    {new Date(
                                      req.requestDate
                                    ).toLocaleDateString()}
                                  </li>
                                ))}
                            </ul>
                          </div>
                        }
                        type="warning"
                        showIcon
                        className="mb-4"
                      />
                    )}

                    {/* Received Requests */}
                    {pendingRequests.filter((req) => req.status === "approved")
                      .length > 0 && (
                      <Alert
                        message="ржЧрзГрж╣рзАржд ржЙрждрзНрждрзЛрж▓ржирзЗрж░ рждржерзНржп"
                        description={
                          <div>
                            <p>
                              ржЖржкржирж┐ ржЗрждрж┐ржоржзрзНржпрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕржирзБрж░рзЛржз ржЧрзНрж░рж╣ржг
                              ржХрж░рзЗржЫрзЗржи:
                            </p>
                            <ul className="list-disc pl-5">
                              {pendingRequests
                                .filter((req) => req.status === "approved")
                                .map((req, index) => (
                                  <li key={index}>
                                    {req.amount} ржЯрж╛ржХрж╛ ({req.paymentMethod}) -{" "}
                                    {new Date(
                                      req.requestDate
                                    ).toLocaleDateString()}
                                  </li>
                                ))}
                            </ul>
                          </div>
                        }
                        type="success"
                        showIcon
                        className="mb-4"
                      />
                    )}

                    <Divider className="my-4 border-green-200" />

                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-3 bg-green-100 rounded border border-green-200">
                        <Text strong className="text-green-700">
                          ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕрж░рзНрже:
                        </Text>
                        <p className="text-xl font-bold text-green-700">
                          {scholarshipDetails.availableBalance} ржЯрж╛ржХрж╛
                        </p>
                        <Text className="text-green-600">
                          ржмрзНржпржХрзНрждрж┐ржЧржд ржЦрж░ржЪрзЗрж░ ржЬржирзНржп
                        </Text>
                      </div>
                      <div className="p-3 bg-green-50 rounded border border-green-200">
                        <Text strong className="text-green-700">
                          рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржмрзНржпрж╛рж▓рзЗржирзНрж╕:
                        </Text>
                        <p className="text-xl font-bold text-green-700">
                          {scholarshipDetails.registrationBalance} ржЯрж╛ржХрж╛
                        </p>
                        <Text className="text-green-600">
                          ржХрзЛрж░рзНрж╕ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржирзЗрж░ ржЬржирзНржп
                        </Text>
                      </div>
                    </div>
                  </div>

                  <Formik
                    initialValues={{
                      amount: "",
                      purpose: "withdrawal",
                      paymentMethod: "",
                    }}
                    validationSchema={Yup.object({
                      amount: Yup.number()
                        .required("ржЕрж░рзНржерзЗрж░ ржкрж░рж┐ржорж╛ржг ржЖржмрж╢рзНржпржХ")
                        .min(100, "рж╕рж░рзНржмржирж┐ржорзНржи рззрзжрзж ржЯрж╛ржХрж╛ ржЙрждрзНрждрзЛрж▓ржи ржХрж░рж╛ ржпрж╛ржмрзЗ")
                        .max(
                          scholarshipDetails.availableBalance,
                          `ржкрзНрж░рж╛ржкрзНржд ржмрзНржпрж╛рж▓рзЗржирзНрж╕рзЗрж░ ржмрзЗрж╢рж┐ ржЙрждрзНрждрзЛрж▓ржи ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛ (ржкрзНрж░рж╛ржкрзНржд ржмрзНржпрж╛рж▓рзЗржирзНрж╕: ${scholarshipDetails.availableBalance} ржЯрж╛ржХрж╛)`
                        ),
                      paymentMethod: Yup.string().required(
                        "ржкрзЗржорзЗржирзНржЯ ржкржжрзНржзрждрж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи"
                      ),
                    })}
                    onSubmit={handleWithdrawalSubmit}
                  >
                    {({
                      errors,
                      touched,
                      values,
                      isSubmitting,
                      setFieldValue,
                    }) => (
                      <Form>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-green-700 mb-2">
                            ржЕржирзБрж░рзЛржзрзЗрж░ ржзрж░ржи
                          </label>
                          <Field
                            name="purpose"
                            as={Select}
                            size="large"
                            className="w-full border-green-300"
                            onChange={(value) =>
                              setFieldValue("purpose", value)
                            }
                          >
                            <Option value="withdrawal">ржлрж╛ржирзНржб ржЙрждрзНрждрзЛрж▓ржи</Option>
                            <Option value="registration">
                              ржХрзЛрж░рзНрж╕ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи
                            </Option>
                          </Field>
                        </div>

                        {values.purpose === "withdrawal" && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-medium text-green-700 mb-2">
                                ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржкрж░рж┐ржорж╛ржг (ржЯрж╛ржХрж╛)
                              </label>
                              <Field
                                as={Input}
                                name="amount"
                                type="number"
                                placeholder="ржЯрж╛ржХрж╛рж░ ржкрж░рж┐ржорж╛ржг рж▓рж┐ржЦрзБржи"
                                size="large"
                                className="w-full border-green-300"
                              />
                              {errors.amount && touched.amount ? (
                                <div className="text-red-500 text-sm mt-1">
                                  {errors.amount}
                                </div>
                              ) : null}
                              <Text className="block mt-1 text-green-600">
                                ржкрзНрж░рж╛ржкрзНржд ржмрзНржпрж╛рж▓рзЗржирзНрж╕:{" "}
                                {scholarshipDetails.availableBalance} ржЯрж╛ржХрж╛
                              </Text>
                            </div>

                            <div className="mb-6">
                              <label className="block text-sm font-medium text-green-700 mb-2">
                                ржкрзЗржорзЗржирзНржЯ ржкржжрзНржзрждрж┐
                              </label>
                              <Field
                                name="paymentMethod"
                                as={Select}
                                placeholder="ржкрзЗржорзЗржирзНржЯ ржкржжрзНржзрждрж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи"
                                size="large"
                                className="w-full border-green-300"
                                onChange={(value) =>
                                  setFieldValue("paymentMethod", value)
                                }
                              >
                                <Option value="bKash">bKash</Option>
                                <Option value="Nagad">Nagad</Option>
                                <Option value="Bank Transfer">
                                  ржмрзНржпрж╛ржВржХ ржЯрзНрж░рж╛ржирзНрж╕ржлрж╛рж░
                                </Option>
                              </Field>
                              {errors.paymentMethod && touched.paymentMethod ? (
                                <div className="text-red-500 text-sm mt-1">
                                  {errors.paymentMethod}
                                </div>
                              ) : null}
                            </div>
                          </>
                        )}

                        {values.purpose === "registration" && (
                          <Alert
                            message="ржХрзЛрж░рзНрж╕ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржирзЛржЯрж┐рж╢"
                            description="ржЖржкржирж╛рж░ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржХрзЛрж░рзНрж╕ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржирзЗрж░ рж╕ржорзЯ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗред ржЖрж▓рж╛ржжрж╛ржнрж╛ржмрзЗ ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржкрзНрж░рзЯрзЛржЬржи ржирзЗржЗред"
                            type="success"
                            showIcon
                            className="mb-6 border-green-300 bg-green-50"
                          />
                        )}

                        <div className="flex space-x-4">
                          <Button
                            onClick={resetForm}
                            size="large"
                            className="flex-1 border-green-500 text-green-700 hover:border-green-700"
                          >
                            ржкрж┐ржЫржирзЗ
                          </Button>
                          <Button
                            type="primary"
                            htmlType="submit"
                            size="large"
                            className="flex-1 bg-green-600 hover:bg-green-700 border-green-700"
                            loading={isSubmitting}
                            disabled={values.purpose === "registration"}
                          >
                            {isSubmitting ? (
                              <>
                                <LoadingOutlined /> ржкрзНрж░рж╕рзЗрж╕рж┐ржВ...
                              </>
                            ) : (
                              "ржЕржирзБрж░рзЛржз рж╕рж╛ржмржорж┐ржЯ ржХрж░рзБржи"
                            )}
                          </Button>
                        </div>
                      </Form>
                    )}
                  </Formik>
                </>
              )}
            </div>
          )}

          {!scanning && step === 3 && (
            <div className="text-center py-8">
              <div className="mb-6">
                <svg
                  className="w-16 h-16 text-green-500 mx-auto"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M5 13l4 4L19 7"
                  ></path>
                </svg>
              </div>
              <Title level={3} className="mb-2 text-green-800">
                ржЕржирзБрж░рзЛржз рж╕ржлрж▓ржнрж╛ржмрзЗ ржЬржорж╛ рж╣рзЯрзЗржЫрзЗ!
              </Title>
              <Text className="block mb-6 text-green-700">
                ржЖржкржирж╛рж░ ржЙрждрзНрждрзЛрж▓ржирзЗрж░ ржЕржирзБрж░рзЛржз ржкрзНрж░рж╛ржкрзНржд рж╣рзЯрзЗржЫрзЗ ржПржмржВ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ ржЪрж▓ржЫрзЗред
              </Text>
              <Button
                type="primary"
                size="large"
                onClick={resetForm}
                className="bg-green-600 hover:bg-green-700 border-green-700"
              >
                ржЖрж░рзЗржХржЯрж┐ ржЕржирзБрж░рзЛржз ржХрж░рзБржи
              </Button>
            </div>
          )}
        </Card>
      </div>
    </div>
  );
};

export default ScholarshipPayment;
